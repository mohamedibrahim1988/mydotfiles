#!/bin/bash
setxkbmap -layout us,ara -option grp:alt_shift_toggle
#when set to exit, mpd_control will exit if you press escape
#when set to break, mpd_control will go the upper level if possible
ESC_ACTION="break"
# source configuration file for rofi if exists

THEME="$HOME/.config/rofi/styles/MoviePlay.rasi"
ROFI="rofi -dmenu -p 'Search:' -theme $THEME -multi-select"

handle_escape() {
    if [ "$ESC_ACTION" = "exit" ]; then
        exit
    else
        return
    fi
}
addaftercurrent() {

    #playlist is empty, just add the song
    if [ "$(mpc playlist | wc -l)" == "0" ]; then
        mpc add "$1"

    #there is no current song so mpd is stopped
    #it seems to be impossible to determine the current songs' position when
    #mpd is stopped, so just add to the end
    elif [ -z "$(mpc current)" ]; then
        mpc play
        CUR_POS=$(mpc | tail -2 | head -1 | awk '{print $2}' | sed 's/#//' | awk -F/ '{print $1}')
        END_POS=$(mpc playlist | wc -l)
        mpc add "$1"
        mpc move $(($END_POS + 1)) $(($CUR_POS + 1))
        mpc stop

    #at least 1 song is in the playlist, determine the position of the
    #currently played song and add $1 after it
    else

        CUR_POS=$(mpc | tail -2 | head -1 | awk '{print $2}' | sed 's/#//' | awk -F/ '{print $1}')
        END_POS=$(mpc playlist | wc -l)
        mpc add "$1"
        mpc move $(($END_POS + 1)) $(($CUR_POS + 1))
    fi
}
addaftercurrentandplay() {

    #playlist is empty, just add the song
    if [ "$(mpc playlist | wc -l)" == "0" ]; then
        mpc add "$1"
        mpc play

    #there is no current song so mpd is stopped
    #it seems to be impossible to determine the current songs' position when
    #mpd is stopped, so just add to the end
    elif [ -z "$(mpc current)" ]; then
        mpc play
        CUR_POS=$(mpc | tail -2 | head -1 | awk '{print $2}' | sed 's/#//' | awk -F/ '{print $1}')
        END_POS=$(mpc playlist | wc -l)
        mpc add "$1"
        mpc move $(($END_POS + 1)) $(($CUR_POS + 1))
        mpc play $(($CUR_POS + 1))

    #at least 1 song is in the playlist, determine the position of the
    #currently played song and add $1 after it
    else

        CUR_POS=$(mpc | tail -2 | head -1 | awk '{print $2}' | sed 's/#//' | awk -F/ '{print $1}')
        END_POS=$(mpc playlist | wc -l)
        mpc add "$1"
        mpc move $(($END_POS + 1)) $(($CUR_POS + 1))
        mpc play $(($CUR_POS + 1))
    fi
}

case $1 in
-l | --longplayer)

    while true; do

        ARTIST=$(mpc list artist | sort -f | $ROFI)
        if [ "$ARTIST" = "" ]; then
            $ESC_ACTION
        fi

        while true; do

            TITLES=$(mpc list title artist "$ARTIST")
            TITLE=$(echo -e "replace all\nadd all\nadd multi\n--------------------------\n$TITLES" | $ROFI)
            if [ "$TITLE" = "" ]; then
                $ESC_ACTION
            elif [ "$TITLE" = "replace all" ]; then
                CUR_SONG=$(mpc current)
                mpc clear
                mpc find artist "$ARTIST" | mpc add
                if [ -n "$CUR_SONG" ]; then mpc play; fi
                $ESC_ACTION
            elif [ "$TITLE" = "add all" ]; then
                mpc find artist "$ARTIST" | mpc add
                $ESC_ACTION
            elif [ "$TITLE" = "add multi" ]; then
                SONGS=$(mpc list title artist "$ARTIST" | $ROFI)
                [ -z "$SONGS" ] && handle_escape
                while IFS= read -r t; do
                    SONG=$(mpc find artist "$ARTIST" title "$t" | head -1)
                    [ -n "$SONG" ] && mpc add "$SONG"
                done <<<"$SONGS"
                #addaftercurrent $SONGS
                mpc play
                $ESC_ACTION

            fi

            while true; do
                DEC=$(echo -e "add after current and play\nadd after current\nreplace\nadd at the end" | $ROFI)
                case $DEC in

                "")
                    $ESC_ACTION
                    ;;

                "add after current and play")
                    addaftercurrentandplay "$(mpc find artist "$ARTIST" title "$TITLE" | head -1)"
                    ;;

                "add after current")
                    addaftercurrent "$(mpc find artist "$ARTIST" title "$TITLE" | head -1)"
                    ;;

                "replace")
                    CUR_SONG=$(mpc current)
                    mpc clear
                    mpc find artist "$ARTIST" title "$TITLE" | head -1 | mpc add
                    if [ -n "$CUR_SONG" ]; then mpc play; fi
                    ;;

                "add at the end")
                    mpc find artist "$ARTIST" title "$TITLE" | head -1 | mpc add
                    ;;

                esac
                $ESC_ACTION
            done
        done
    done
    ;;
-j | --jump)

    TITLE=$(mpc playlist | $ROFI)
    if [ "$TITLE" = "" ]; then exit; fi
    POS=$(mpc playlist | grep -n "$TITLE" | awk -F: '{print $1}')
    mpc play $POS
    ;;
esac
setxkbmap -layout us -option grp:alt_shift_toggle
